# 部署策略
| **策略**         | **说明**                                                                                   | **解决方式**                                                                                                        |
|------------------|--------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------|
| **负载均衡**      | 多个计算节点之间均匀分配负载，避免单个节点过载，从而提高系统的可用性和性能，减少请求超时和瓶颈问题。 | 使用开源Apache APISIX、Kong、HAProxy等进行智能路由，通过路由算法（如轮询、加权轮询、最少连接等）根据健康检查结果自动调整流量分配。或使用 Kubernetes 作为容器编排平台，利用其内置的负载均衡功能实现基于服务的智能负载均衡。 |
| **弹性扩容**      | 根据实时负载情况动态调整计算资源，支持自动扩展和缩减，以应对流量高峰和低谷。                  | 利用容器编排平台（如 Kubernetes）实现自动扩缩容，基于队列长度、QPS 和资源使用率触发扩容或缩容策略。              |
| **优先级管理**    | 任务分类，多个队列，根据请求的紧急程度和重要性为任务分配优先级，确保关键任务能够及时处理。     | Temporal框架，配置多个 Worker，为高优先级任务分配独立的队列和资源池；设置优先级调度策略（如 FIFO+优先级）。 |
| **优化部署**      | 考虑请求的地理位置，就近调度至最近的计算资源池（边缘节点或区域数据中心）。                  | 多机房部署，根据乐高机房就近调度，减少传输延迟。邀请SRE架构师评估。                                                |
| **资源最大化利用**| 通过合理调度和任务合并，最大化计算资源的利用率，降低空闲时间和资源浪费。                     | 利用分布式任务调度系统，将小任务合并处理；使用资源利用率监控，分析不同转码任务，识别它们的计算需求。             |
| **容错与冗余**    | 设计冗余机制和容错能力，确保在节点故障或网络问题时，系统能够自动切换，保证服务的高可用性。      | 使用多活架构和健康检查机制，节点故障后自动切换到备用节点；任务状态持久化，支持任务在其他节点重新运行。         |
| **任务重试**      | 对于因节点故障而失败的任务，自动进行重试，确保任务最终能够成功完成。                        | 设计任务状态管理系统，记录任务进度和重试次数；设置重试间隔和最大重试次数，避免无限重试导致资源浪费。           |
| **资源回收**      | 对于长时间未完成的任务或已完成的任务，及时释放所占用的计算资源，确保资源得到充分利用。        | 定期扫描任务队列，清理过期或完成的任务；对于超时任务，终止并释放相关资源，记录日志以供后续分析。             |
| **监控与反馈**    | 实时监控系统性能和资源使用情况，包括 CPU、内存、网络等指标，防止资源过载。                  | 使用 Prometheus、Grafana 等监控工具，定时采集资源指标，设置阈值报警，动态调整调度策略。                       |
| **预警响应**      | 及时响应异常资源状态，进行手动或自动扩容处理。                                            | 配置自动化扩容策略，异常情况时通过短信、邮件等方式通知管理员，同时触发应急预案，如临时启动额外资源节点或降级低优先级服务。 |

## 任务优先级
| **环节**         | **描述**                                                                                   | **工作内容**                                                                                                            |
|------------------|--------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------|
| **任务队列**      | 管理不同优先级和类型的任务队列。                                                              | 设计高、中、低优先级队列。使用消息队列技术如RabbitMQ、Kafka。实现实时队列监控。本系统使用Temporal+Redis，自定义work组。|
| **优先级管理**    | 定义和管理任务的优先级。                                                                     | 定义优先级标准。为任务分配优先级。允许动态调整优先级。                                                                   |
| **资源分配**      | 分配计算、存储和网络资源。                                                                   | 建立资源池。定义资源计量单位。实现资源调度算法。                                                                          |
| **任务调度**      | 调度任务以优化资源使用和响应时间。                                                           | 设计调度策略。实现中心调度器。优化调度策略。                                                                               |
| **容错机制**      | 确保系统在故障时能够自动恢复和继续执行任务。                                                 | 实现故障检测。实现自动重试机制。实现故障转移机制。                                                                       |
| **状态更新**      | 跟踪和更新任务状态。                                                                         | 为每个任务维护状态。将状态存储在可靠存储系统。在状态变化时通知相关方。                                                     |
| **执行回调**      | 在状态更新同时，执行回调，通知调用方。                                                       | 当任务完成时，通过消息队列或回调API接口等方式将任务状态变化通知调用方。                                                   |

